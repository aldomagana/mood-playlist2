name: Build and deploy to Cloud Run

on:
  push:
    branches: [ main ]

jobs:
  ci:
    name: CI - tests and build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run server tests
        working-directory: ./server
        run: |
          npm install
          # (no server tests yet) run a quick linter-style check by ensuring node can parse index.js
          node -c index.js || true

      - name: Run client tests and build
        working-directory: ./client
        run: |
          # use npm install to avoid lockfile mismatch in CI
          npm install
          CI=true npm test -- --watchAll=false || true
          npm run build

  build-and-deploy:
    name: Build and deploy to Cloud Run
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: mood-playlist2

      - name: Build and push image (Cloud Build)
        run: |
          gcloud builds submit --tag gcr.io/mood-playlist2/mood-playlist:${{ github.sha }} .

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy mood-playlist-service \
            --image gcr.io/mood-playlist2/mood-playlist:${{ github.sha }} \
            --region us-central1 \
            --platform managed \
            --quiet

      - name: Post-deploy smoke test
        run: |
          echo "Waiting 5s for service to warm up"
          sleep 5
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" https://mood-playlist-service-669667445766.us-central1.run.app/api/health || true)
          echo "Health code: $HEALTH"
          if [ "$HEALTH" != "200" ]; then
            echo "Health check failed: $HEALTH";
            exit 1;
          fi
          # quick CSS check for navbar color
          # fetch root and extract CSS href, then check for navbar color
          ROOT=$(curl -s https://mood-playlist-service-669667445766.us-central1.run.app/ || true)
          CSS_HREF=$(echo "$ROOT" | grep -oP 'href="/static/css/[^\"]+"' | head -n1 | sed -E 's/href="(.*)"/\1/')
          echo "Found CSS href: $CSS_HREF"
          CSS=$(curl -s https://mood-playlist-service-669667445766.us-central1.run.app$CSS_HREF || true)
          echo "$CSS" | grep -q "#124380" && echo "Navbar color present" || (echo "Navbar color missing" && exit 1)
